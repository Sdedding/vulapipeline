# TODO: We don't have artifacts in woodpecker pipelines (There are plugins like https://woodpecker-ci.org/plugins/S3%20Plugin)
#       so for now we should print out all results to stdout.
# Override default CI env variable for now (see https://github.com/pypa/pipenv/issues/5554)

when:
  event: [push, tag, pull_request, manual]

steps:
  nix:
    depends_on: []
    image: nixos/nix
    environment:
      NIX_CONFIG: extra-experimental-features = nix-command flakes
    commands:
      - system=$(nix-instantiate --eval --expr "builtins.currentSystem")
      - nix build --print-build-logs .#checks.$system.treefmt
      - nix build --print-build-logs

  mypy:
    depends_on: []
    image: python:3.10-bookworm
    commands:
      - export CI=true
      - PATH=$PATH:~/.local/bin
      - ./misc/install-ci-deps.sh
      - make mypy

  check_test:
    depends_on: []
    image: python:3.10-bookworm
    commands:
      - export CI=true
      - PATH=$PATH:~/.local/bin
      - ./misc/install-ci-deps.sh
      - . $(pipenv --venv)/bin/activate
      - make check
      - xvfb-run -- pipenv run pytest -v 
      - xvfb-run -- pipenv run pytest --cov
      - make sast-analysis
      - make wheel
      - make deb
      - dpkg -I dist/*.deb
